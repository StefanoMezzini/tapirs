---
title: "Appendix - R Scripts for reproducing the results presented in the main text"
author: "EP Medici, S Mezzini, CH Fleming, JM Calabrese, MJ Noonan"
date: "`r Sys.Date()`"
output:
  pdf_document:
      latex_engine: xelatex
      number_sections: true
      toc: true
---

```{r chunk-options, include=FALSE}
# suppress warnings from ggplot()
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)

# allows changing character size of the output to "small"
# see https://stackoverflow.com/questions/25646333/code-chunk-font-size-in-rmarkdown-with-knitr-and-latex
def.chunk.hook <- knitr::knit_hooks$get("chunk")
knitr::knit_hooks$set(chunk = function(x, options) {
  x <- def.chunk.hook(x, options)
  ifelse(test = options$size != "normalsize",
         yes = paste0("\n \\", options$size,"\n\n", x, "\n\n \\normalsize"),
         no = x)
})
```

In this appendix we provide details on the analyses and R code used to generate all of the results presented in the main text. For full details on these analyses see the github repository associated with this manuscript at: https://github.com/StefanoMezzini/tapirs.

Section 1, *Pre-analysis setup*, attaches the packages needed for the analysis and imports the main dataset.

Section 2, *Summary statistics for movement and space use parameters*, shows how results were obtained for each section, following the order in which results are presented in the manuscript.

Section 3, *Figures*, shows how figures 2-6 were created (with minor changes for aesthetic purposes and ease of readability). Figure 1 is not recreated here because the final version was created in Photoshop. The code to create the figure's components can be found in the `R` script `analysis/maps.R`.

Section 4, *Core home range analysis*, repeats the sections 2 and 3 for the 50% AKDE home range estimates rather than the 95% AKDE.

\newpage

# Pre-analysis setup

```{r setup, message=FALSE}
library('purrr')     # for functional programming
library('mgcv')      # for fitting GAMs
library('ctmm')      # for animal movement analyses
library('tidyr')     # for data wrangling
library('MuMIn')     # for model selection
library('sf')        # to work with spData maps
library('sp')        # to import spatial layers
library('raster')    # to import human footprint index raster
library('ggplot2')   # for plotting
library('ggmap')     # for maps
library('cowplot')   # for plot grids
library('gratia')    # for seq_min_max(), draw()
library('lubridate') # makes working with dates smoother
library('dplyr')     # for data wrangling
library('ncdf4')     # required for ml-HFI raster
theme_set(theme_bw())

# color palette
pal <- c('#4477AA', '#ff8c00', '#66CCEE', '#009900', '#CCBB44', '#EE6677', '#AA3377')
N <- 74 # number of tapirs

tapirs <- readRDS('../models/tapirs-final.rds') %>% # tapir data
  mutate(
    # translate name
    region.lab = if_else(region.lab == 'Mata Atlantica', 'Atlantic forest', region.lab),
    # convert tau_p from seconds to days
    tau.position.est = tau.position.est / (60^2 * 24),
    tau.position.low = tau.position.low / (60^2 * 24),
    tau.position.high = tau.position.high / (60^2 * 24),
    # convert tau_v from seconds to hours
    tau.velocity.est = tau.velocity.est / (60^2),
    tau.velocity.low = tau.velocity.low / (60^2),
    tau.velocity.high = tau.velocity.high / (60^2))
```

\newpage

# Summary statistics for movement and space use parameters

<!-- # Individual variation in movement and space use -->

<!-- use results = 'hide' to hide the output from meta()-->

```{r create-tap, results = 'hide'}
est <- function(y, parameter = c('mean', 'lwr', 'upr')) {
  if(sum(!is.na(y)) > 2) { # if there's at least 2 observations
    # fit a Gamma GLM with only an intercept to estimate the group-level mean
    m <- gam(y ~ 1,
             family = Gamma(link = 'log'),
             method = 'REML')
    
    if(length(parameter) > 1) stop('Specify a single parameter.\n')
    
    pred <- predict(m, newdata = tibble(c = 1), se.fit = TRUE, scale = 'link') %>%
      as.data.frame() %>%
      mutate(lwr = exp(fit - 1.96 * se.fit),
             mean = exp(fit),
             upr = exp(fit + 1.96 * se.fit))
    pred[1, parameter]
  } else {NA_real_}
}

tap <-
  tapirs %>%
  bind_rows(
    bind_cols(name = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Overall'),
              region.lab = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Overall'),
              # 95% home range estimates
              bind_rows(
                meta(tapirs$model[tapirs$region == 'atlantica'], plot = FALSE)[1, ],
                meta(tapirs$model[tapirs$region == 'pantanal'], plot = FALSE)[1, ],
                meta(tapirs$model[tapirs$region == 'cerrado'], plot = FALSE)[1, ],
                meta(tapirs$model, plot = FALSE)[1, ]) %>%
                rename(area.low = low, area.est = est, area.high = high),
              # regional estimates
              group_by(tapirs, region) %>%
                summarize(tau.position.e = est(tau.position.est, 'mean'),
                          tau.position.low = est(tau.position.est, 'lwr'),
                          tau.position.high = est(tau.position.est, 'upr'),
                          tau.velocity.e = est(tau.velocity.est, 'mean'),
                          tau.velocity.low = est(tau.velocity.est, 'lwr'),
                          tau.velocity.high = est(tau.velocity.est, 'upr'),
                          speed.e = est(speed.est, 'mean'),
                          speed.low = est(speed.est, 'lwr'),
                          speed.high = est(speed.est, 'upr')) %>%
                rename(tau.position.est = tau.position.e,
                       tau.velocity.est = tau.velocity.e,
                       speed.est = speed.e) %>%
                bind_rows(
                  tapirs %>%
                    summarize(tau.position.est = est(tapirs$tau.position.est, 'mean'),
                              tau.position.low = est(tapirs$tau.position.est, 'lwr'),
                              tau.position.high = est(tapirs$tau.position.est, 'upr'),
                              tau.velocity.est = est(tapirs$tau.velocity.est, 'mean'),
                              tau.velocity.low = est(tapirs$tau.velocity.est, 'lwr'),
                              tau.velocity.high = est(tapirs$tau.velocity.est, 'upr'),
                              speed.est = est(tapirs$speed.est, 'mean'),
                              speed.low = est(tapirs$speed.est, 'lwr'),
                              speed.high = est(tapirs$speed.est, 'upr'))))) %>%
  mutate(name = factor(name, levels = c(unique(tapirs$name), 'Atlantic forest',
                                        'Pantanal', 'Cerrado', 'Overall')),
         region.lab = factor(region.lab,
                             levels = c('Atlantic forest', 'Pantanal', 'Cerrado',
                                        'Overall')),
         average = if_else(name %in% c('Atlantic forest','Pantanal','Cerrado','Overall'),
                           'Group mean', 'Individual') %>%
           factor(levels = c('Individual', 'Group mean'))) %>%
  select(region.lab, name, area.low:area.high, tau.position.est:tau.position.low,
         speed.est:tau.velocity.low, average)
```

```{r}
# est = estimated mean; low = lower 95% CI limit, high = upper 95% CI limit
tap %>%
  filter(average == 'Group mean') %>% # only group means
  select(-c(average, region.lab)) %>%
  relocate(name) %>% # move to be first column
  mutate(across(where(is.double), \(x) round(x, 2))) %>% # round to 2 decimals
  t() %>% # transpose to keep within page limits
  knitr::kable(caption = "Habitat-specific and overall means and 95% confidence intervals for the tapirs' movement parameter estimates.")
```

The overall mean 95% home range estimate was 8.31 km^2^ with CI (6.53, 10.42) km^2^ (see Table 1 above).

```{r}
range(tapirs$area.est) %>% round(digits = 1)
```

The range in home range area estimates was 1.0 - 29.7 km^2^.

```{r}
round(range(tapirs$tau.position.est, na.rm = TRUE), 2)
```

The range in range crossing time was 0.05-12.76 days.

The overall average directional persistence was 0.44 hours with a 95% CI of (0.38, 0.51) hours (see Table 1 above).

```{r}
round(range(tapirs$tau.velocity.est, na.rm = TRUE), 2)
```

The range in mean directional persistence timescale was 0.17-1.88 hours.

The overall average speed was 11.2 km/day with a 95% CI of (10.1, 12.3) km/day (see Table 1 above).

```{r}
range(tapirs$speed.est, na.rm = TRUE) %>% round(2)
```

The range in average daily speed was 1.51 - 25.96 km/day.

When we first submitted the manuscript using `ctmm` version 0.6.1, `ctmm::meta()` could only produce estimates for home ranges. Thus, we used Gamma GLMs fit via `mgcv::gam()` to estimate differences in mean daily movement speed between animals of different ages and sexes:

```{r}
# Differences in movement speed between animals of different ages and sexes
m.speed.sex <- gam(speed.est ~ sex,
                   family = Gamma('log'),
                   data = tapirs,
                   method = 'REML')
m.speed.age <- gam(speed.est ~ adult,
                   family = Gamma('log'),
                   data = tapirs,
                   method = 'REML')
# model summaries
summary(m.speed.sex)
summary(m.speed.age)

# predictions
tibble(Sex = c('FEMALE', 'MALE'),
       bind_cols(predict(m.speed.sex, tibble(sex = Sex), se.fit = TRUE))) %>%
  mutate(est = round(exp(fit), 2),
         lwr = round(exp(fit - 1.96 * se.fit), 2),
         upr = round(exp(fit + 1.96 * se.fit), 2))
tibble(Adult = c('Yes', 'No'),
       bind_cols(predict(m.speed.age, tibble(adult = Adult), se.fit = TRUE))) %>%
  mutate(est = round(exp(fit), 2),
         lwr = round(exp(fit - 1.96 * se.fit), 2),
         upr = round(exp(fit + 1.96 * se.fit), 2))
```

There was no evidence that daily speed differed between sexes (females: 10.5 km/day, 95% CI: 9.19 - 12.0; males: 11.9 km/day; 95% CI: 10.3 - 13.7, $p$ = 0.22, 4a), nor between age groups (adults: 11.8 km/day, 95% CI: 10.6 - 13.2; sub-adults: 9.52 km/day, 95% CI: 7.94 - 11.4; $p$ = 0.053, Fig. 4b).

```{r}
# by sex
meta(list(female = filter(tapirs, sex == 'FEMALE')$akde,
          male = filter(tapirs, sex == 'MALE')$akde),
     plot = FALSE, verbose = TRUE) # verbose output with CIs

# by age group
meta(list(subadult = filter(tapirs, adult == 'No')$akde,
          adult = filter(tapirs, adult == 'Yes')$akde),
     plot = FALSE, verbose = TRUE)
```

Using `ctmm::meta()`, we found that home range area was not significantly different ($\alpha = 0.05$) between sexes (females: mean = 6.11, 95% CI = (4.53, 8.07); males: mean = 5.46, 95% CI = (4.03, 7.23); LRT for female > male = 1.09, 95% CI = (0.70, 1.63)) nor between age groups (sub-adults: mean = 6.99, 95% CI = (3.87, 11.65); adults: mean = 5.37, 95% CI = (4.39, 6.50); LRT for sub-adult > adult = 1.29, 95% CI = (0.65, 2.18)).

\newpage

# Figures

## ml-HFI map (figure 1)

Figure 1 is not recreated here because the final version was created in Photoshop. The code to create the figure's components can be found in the `R` script `analysis/maps.R`.

## AKDE 95% home range estimates (figure 2)

```{r figure-2, fig.width = 6.46, height = 12, message=FALSE}
tapirs <- tapirs %>%
  mutate(proj = map(data, function(d) CRS(d@info$projection)),
         akde.df =
           map(1:N,
               function(i)
                 SpatialPolygonsDataFrame.UD(akde[[i]],
                                             proj4string = proj[[i]]) %>%
                 spTransform(CRS("+proj=longlat")) %>%
                 fortify()))

atl.akdes <- bind_rows(tapirs$akde.df) %>% filter(grepl('AF_', group))
pan.akdes <- bind_rows(tapirs$akde.df) %>% filter(grepl('PA_', group))
cer.akdes <- bind_rows(tapirs$akde.df) %>% filter(grepl('CE_', group))

plot.akde <- function(reg) {
  if(reg == 'Atlantic Forest') {
    r <- 'AF_'
    ZOOM <- 11
  } else if(reg == 'Pantanal') {
    r <- 'PA_'
    ZOOM <- 12
  } else if(reg == 'Cerrado'){
    r <- 'CE_'
    ZOOM <- 10
  } else {
    stop('invalid region name')
  }
  akdes <- bind_rows(tapirs$akde.df) %>%
    filter(grepl(r, group), grepl('est', group))
  
  # box expansion factor 
  k <- case_when(reg == 'Pantanal' ~ 0.6,
                 reg == 'Cerrado' ~ 0.1,
                 reg == 'Atlantic Forest' ~ 0.5)
  
  BOX <- akdes %>%
    summarize(left = min(long),
              bottom = min(lat),
              right = max(long),
              top = max(lat)) %>%
    
    # expand boxes slightly
    mutate(left = left - k * (right - left),
           right = right + k * (right - left),
           bottom = bottom - 0.1 * (top - bottom),
           top = top + 0.1 * (top - bottom)) %>%
    unlist()
  
  MAP <- get_map(BOX, zoom = ZOOM,
                 maptype = "satellite",
                 style="element:labels|visibility:off|
                    style=feature:administrative.land_parcel|
                    visibility:off|style=feature:administrative.neighborhood
                    |visibility:off")
  
  TITLE <- case_when(reg == 'Atlantic Forest'~ 'a)',
                     reg == 'Pantanal' ~ 'b)',
                     reg == 'Cerrado' ~ 'c)')
  
  ggmap(MAP, darken = c(0.3, "white")) +
    geom_polygon(aes(x = long, y = lat, fill = group), color = 'black',
                 alpha = 0.5, akdes, lwd = 0.15) +
    scale_fill_viridis_d('Human Footprint Index', option = 'B') +
    labs(x = 'Longitude', y = 'Latitude', title = TITLE) +
    theme(panel.border = element_rect(colour = 'black', fill = 'transparent'),
          legend.position = 'none')
}

plot_grid(plot.akde('Atlantic Forest'), plot.akde('Pantanal'),
          plot.akde('Cerrado'), ncol = 2) # used ncol = 1 for figure in the main text
```

\newpage

## Parameter estimates using `ctmm::meta()` (figure 3)

```{r figure-3a}
# 3a) meta() of areas
ggplot(tap) +
  geom_segment(aes(x = area.low, xend = area.high, y = name, yend = name,
                   color = region.lab), lwd = 2) +
  geom_point(aes(x = area.est, y = name, shape = average), col = 'black', size = 1.2) +
  geom_point(aes(x = area.est, y = name, shape = average), col = 'white', size = 0.7) +
  scale_shape_manual(element_blank(), values = c(19, 17)) +
  scale_color_manual('Region', values = c(pal[1:3], 'black'),
                     labels = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Overall')) +
  scale_y_discrete(limits = rev,
                   labels = c('Means', 'Cerrado', 'Pantanal', 'Atlantic forest'),
                   breaks = c('Atlantic forest', 'CE_15_KURUKA',
                              'PA_33_GABRIELA', 'AF_14_JAMESBOND')) +
  labs(x = bquote('Estimated 95% home range area'~(km^2)),
       y = NULL)
```

\newpage

```{r figure-3b}
# 3b) home range crossing times
ggplot(tap) +
  geom_segment(aes(x = tau.position.low,
                   xend = tau.position.high, y = name, yend = name,
                   color = region.lab), lwd = 2) +
  geom_point(aes(x = tau.position.est, y = name, shape = average),
             col = 'black', size = 1.2) +
  geom_point(aes(x = tau.position.est, y = name, shape = average),
             col = 'white', size = 0.7) +
  scale_shape_manual(element_blank(), values = c(19, 17)) +
  scale_color_manual('Region', values = c(pal[1:3], 'black'),
                     labels = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Overall')) +
  scale_y_discrete(limits = rev,
                   labels = c('Means', 'Cerrado', 'Pantanal', 'Atlantic forest'),
                   breaks = c('Atlantic forest', 'CE_15_KURUKA',
                              'PA_33_GABRIELA', 'AF_14_JAMESBOND')) +
  labs(x = 'Range crossing time (days)', y = NULL)
```

\newpage

```{r figure-3c}
# 3c) velocity autocorrelation timescale
ggplot(tap) +
  geom_segment(aes(x = tau.velocity.low, xend = tau.velocity.high, y = name, yend = name,
                   color = region.lab), lwd = 2) +
  geom_point(aes(x = tau.velocity.est, y = name, shape = average),
             col = 'black', size = 1.2) +
  geom_point(aes(x = tau.velocity.est, y = name, shape = average),
             col = 'white', size = 0.7) +
  scale_shape_manual(element_blank(), values = c(19, 17)) +
  scale_color_manual('Region', values = c(pal[1:3], 'black'),
                     labels = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Overall')) +
  scale_y_discrete(limits = rev,
                   labels = c('Means', 'Cerrado', 'Pantanal', 'Atlantic forest'),
                   breaks = c('Atlantic forest', 'CE_15_KURUKA',
                              'PA_33_GABRIELA', 'AF_14_JAMESBOND')) +
  labs(x = 'Directional persistence timescale (hours)', y = NULL)
```

\newpage

```{r figure-3d}
# 3d) mean movement speeds
ggplot(tap) +
  geom_segment(aes(x = speed.low, xend = speed.high,
                   y = name, yend = name, color = region.lab), lwd = 2) +
  geom_point(aes(x = speed.est, y = name, shape = average), col = 'black', size = 1.2) +
  geom_point(aes(x = speed.est, y = name, shape = average), col = 'white', size = 0.7) +
  scale_shape_manual(element_blank(), values = c(19, 17)) +
  scale_color_manual('Region', values = c(pal[1:3], 'black'),
                     labels = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Overall')) +
  scale_y_discrete(limits = rev,
                   labels = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Means'),
                   breaks = c('AF_17_ESPERTA', 'PA_33_GABRIELA', 'CE_15_KURUKA',
                              'Atlantic forest')) +
  labs(x = 'Estimated average speed (km/day)', y = NULL)
```

\newpage

## Strip charts (figure 4)

```{r figure-4, results='hide'}
# import data
tapirs <- tapirs %>%
  mutate(sex = if_else(sex == 'FEMALE', 'Female', 'Male'),
         adult = if_else(adult == 'Yes', 'Adult', 'Young'),
         name = factor(name,
                       levels = c(unique(name), 'Atlantic forest', 'Pantanal', 'Cerrado',
                                  'Overall')),
         sex_r = paste(sex, region.lab, sep = '_') %>%
           factor(levels = c('Female_Atlantic forest', 'Female_Pantanal',
                             'Female_Cerrado', 'Male_Atlantic forest',
                             'Male_Pantanal', 'Male_Cerrado')),
         adult_r = paste(adult, region.lab, sep = '_') %>%
           factor(levels = c('Adult_Atlantic forest', 'Adult_Pantanal',
                             'Adult_Cerrado', 'Young_Atlantic forest',
                             'Young_Pantanal', 'Young_Cerrado')))

# means and CIs
m_speed_sex <- gam(speed.est ~ sex + region.lab,
                   family = Gamma('log'),
                   data = tapirs,
                   method = 'REML')
m_speed_age <- gam(speed.est ~ adult + region.lab,
                   family = Gamma('log'),
                   data = tapirs,
                   method = 'REML')

# predictions ---
## speed, sex
summ_ss <-
  expand_grid(sex = unique(tapirs$sex),
              region.lab = unique(tapirs$region.lab)) %>%
  tibble(bind_cols(predict(m_speed_sex, se.fit = TRUE,
                           tibble(sex = sex, region.lab = region.lab)))) %>%
  mutate(sex_r = paste(sex, region.lab, sep = '_') %>%
           factor(levels = levels(tapirs$sex_r)),
         est = round(exp(fit), 2),
         lwr = round(exp(fit - 1.96 * se.fit), 2),
         upr = round(exp(fit + 1.96 * se.fit), 2))
## speed, adult
summ_sa <-
  expand_grid(adult = unique(tapirs$adult),
              region.lab = unique(tapirs$region.lab)) %>%
  tibble(bind_cols(predict(m_speed_age, se.fit = TRUE,
                           tibble(adult = adult, region.lab = region.lab)))) %>%
  mutate(adult_r = paste(adult, region.lab, sep = '_') %>%
           factor(levels = levels(tapirs$adult_r)),
         est = round(exp(fit), 2),
         lwr = round(exp(fit - 1.96 * se.fit), 2),
         upr = round(exp(fit + 1.96 * se.fit), 2))

## function to extract home ranges
hr_estimates <- function(REGION, SEX = NA, ADULT = NA, level.ud) {
  if(! is.na(SEX)) {
    d <- tapirs %>% filter(sex == SEX) # filter to a single sex  
  } else {
    d <- tapirs %>% filter(adult == ADULT) # filter to a single sex
  }
  
  d <-
    d %>%
    filter(region.lab == REGION) %>% # filter to a single region
    pull(akde) %>%
    meta(plot = FALSE, level.UD = level.ud) %>%
    as_tibble() %>%
    slice(1) %>%
    rename(lwr = low, upr = high) %>%
    mutate(region.lab = REGION, sex = SEX, adult = ADULT)
  
  if(! is.na(SEX)) {
    d <- d %>% mutate(sex_r = paste(sex, region.lab, sep = '_') %>%
                        factor(levels = levels(tapirs$sex_r)))
  } else {
    d <- d %>% mutate(adult_r = paste(adult, region.lab, sep = '_') %>%
                        factor(levels = levels(tapirs$adult_r)))
  }
}

## home range, sex
summ_as <-
  expand_grid(sex = unique(tapirs$sex),
              region.lab = unique(tapirs$region.lab)) %>%
  mutate(bind_cols(map2_dfr(region.lab, sex,
                            \(x, y) hr_estimates(REGION = x, SEX = y, level.ud = 0.95))))

## home range, adult
summ_aa <-
  expand_grid(adult = unique(tapirs$adult),
              region.lab = unique(tapirs$region.lab)) %>%
  mutate(bind_cols(map2_dfr(region.lab, adult,
                            \(x, y) hr_estimates(REGION = x, ADULT = y, level.ud=0.95))))

# function for summary plots ----
summary_plot <- function(Y, group = c('sex', 'adult')) {
  
  x <- paste0(group, '_r')
  summarized <- get(paste0('summ_', substr(Y, 1, 1), substr(x, 1, 1)))
  
  if(length(group) > 1) stop('Select only one group.')
  
  colnames(tapirs)[grepl(x, colnames(tapirs))] <- 'x'
  colnames(tapirs)[grepl(Y, colnames(tapirs))] <- 'y'
  colnames(summarized)[grepl(x, colnames(summarized))] <- 'x'
  
  p <- 
    ggplot(tapirs) +
    # CIs
    geom_errorbar(aes(x, ymin = lwr, ymax = upr, color = region.lab),
                  summarized, lwd = 3, width = 0, alpha = 0.5) +
    # data
    geom_jitter(aes(x, y, color = region.lab), shape = 4, width = 0.2, size = 2,
                na.rm = TRUE) +
    # means
    geom_point(aes(x, est), summarized, size = 2) +
    geom_point(aes(x, est), summarized, color = 'white') +
    
    # theme
    scale_fill_manual('Region', values = pal, aesthetics = c('fill', 'color'),
                      breaks = c('Atlantic forest', 'Pantanal', 'Cerrado')) +
    theme(legend.position = 'none')
  
  # add appropriate labels depending on grouping
  if(group == 'sex') {
    p <- p +
      scale_x_discrete(NULL, breaks = c('Female_Pantanal', 'Male_Pantanal'),
                       labels = c('Female', 'Male'))
  } else {
    p <- p +
      scale_x_discrete(NULL, breaks = c('Adult_Pantanal', 'Young_Pantanal'),
                       labels = c('Adult', 'Young'))
  }
  
  # add appropriate y label
  if(Y == 'speed.est') {
    p + scale_y_continuous('Speed (km/day)')
  } else {
    p + scale_y_continuous(expression(Home~range~(km^2)))
  }
}

# summary plots ----
spe_s <- summary_plot(group = 'sex', Y = 'speed.est')
spe_a <- summary_plot(group = 'adult', Y = 'speed.est')
hr_s <- summary_plot(group = 'sex', Y = 'area.est')
hr_a <- summary_plot(group = 'adult', Y = 'area.est')
```

```{r}
plot_grid(get_legend(spe_s +
                       theme(legend.position = 'top')),
          plot_grid(spe_s, spe_a, hr_s, hr_a, ncol = 2, label_y = 1.08,
                    labels = c('a)', 'b)', 'c)', 'd)')),
          ncol = 1, rel_heights = c(0.1, 1))
```

\newpage

## Variation in movement across biomes and habitat composition (figure 5)

The best model is found using `MuMIn::dredge()`. Smooth terms are allowed to have a maximum `k` of 10 (or 5 if there are not enough unique values). The models are fit using maximum likelihood while using `MuMIn::dredge()`, but the best model is fit using Restricted Maximum Likelihood (REML).

```{r figure-5}
tapirs.lu <- readRDS('../models/tapirs-land-use.rds') %>%
  mutate(tau.velocity.est = tau.velocity.est / (60^2), # from seconds to hours
         tau.velocity.low = tau.velocity.low / (60^2),
         tau.velocity.high = tau.velocity.high / (60^2))
tapirs.lu.sp <- filter(tapirs.lu, !is.na(speed.est))
tapirs.lu.tv <- filter(tapirs.lu, !is.na(tau.velocity.est))

# only use groups with at least 5 unique values
dplyr::select(tapirs.lu, `?`:plantation) %>%
  pivot_longer(-c()) %>%
  group_by(name) %>%
  summarize(unique = length(unique(value)),
            min = min(value),
            max = max(value)) %>%
  arrange(desc(unique)) %>%
  mutate(`> 5 uniques` = unique > 5,
         `> 10 uniques` = unique > 10)
```

<!-- print code but don't evaluate it -->

```{r, eval=FALSE}
# Gamma GAM regression on home range estimate
dredge(global.model = gam(area.est ~
                            s(forest, k = 10) +
                            s(floodplain, k = 10) +
                            s(savannah, k = 10) +
                            s(dirt, k = 10) +
                            s(pasture, k = 5) +
                            s(crop, k = 5) +
                            s(water, k = 5),
                          family = Gamma('log'),
                          data = tapirs.lu,
                          na.action = na.fail,
                          method = 'ML'), # need to use ML with dredge()
       rank = 'AICc') %>%
  head(20)
```

<!-- evaluate code but don't print it -->

```{r dredge-area, size='small', echo=FALSE}
options(width = 110)
# Gamma GAM regression on home range estimate
dredge(global.model = gam(area.est ~ # full model
                            s(forest, k = 10) +
                            s(floodplain, k = 10) +
                            s(savannah, k = 10) +
                            s(dirt, k = 10) +
                            s(pasture, k = 5) +
                            s(crop, k = 5) +
                            s(water, k = 5),
                          family = Gamma('log'),
                          data = tapirs.lu,
                          na.action = na.fail,
                          method = 'ML'), # need to use ML with dredge()
       rank = 'AICc') %>%
  head(20)
options(width = 74)
```

Model 3 with `s(dirt)` as the only predictor is the best (parsimonious) model, since it is the best single-term model, and its AICc is not much larger than any of the models with a lower AICc (`delta` < 3.5). Still, the effect of `s(dirt)` is negligible.

```{r}
m.hr <- gam(area.est ~ s(dirt, k = 5),
            family = Gamma('log'),
            data = tapirs.lu,
            method = 'REML')
summary(m.hr)
```

```{r, eval=FALSE}
# Gamma GAM regression on average speed estimate
dredge(global.model = gam(speed.est ~
                            s(forest, k = 10) +
                            s(floodplain, k = 10) +
                            s(savannah, k = 10) +
                            s(dirt, k = 10) +
                            s(pasture, k = 5) +
                            s(crop, k = 5) +
                            s(water, k = 5),
                          family = Gamma('log'),
                          data = tapirs.lu.sp, # cannot have NAs
                          na.action = na.fail,
                          method = 'ML'),
       rank = 'AICc') %>%
  head(20)
```

```{r dredge-speed, size='small', echo=FALSE}
options(width = 110)
# Gamma GAM regression on average speed estimate
dredge(global.model = gam(speed.est ~
                            s(forest, k = 10) +
                            s(floodplain, k = 10) +
                            s(savannah, k = 10) +
                            s(dirt, k = 10) +
                            s(pasture, k = 5) +
                            s(crop, k = 5) +
                            s(water, k = 5),
                          family = Gamma('log'),
                          data = tapirs.lu.sp, # cannot have NAs
                          na.action = na.fail,
                          method = 'ML'),
       rank = 'AICc') %>%
  head(20)
options(width = 74)
```

No term contributed significantly to the model, since no model had an AICc lower than 4.35 with respect to the null model with only an intercept term (`speed.est ~ 1`, see model 1 in the table above).

```{r}
# Gamma GAM regression on average directional persistence (tau_v) estimate
filter(tapirs.lu, !is.na(tau.velocity.est)) %>%
  dplyr::select(`?`:plantation) %>%
  pivot_longer(-c()) %>%
  group_by(name) %>%
  summarize(unique = length(unique(value)),
            min = min(value),
            max = max(value)) %>%
  arrange(desc(unique)) %>%
  mutate(`> 5 uniques` = unique > 5,
         `> 10 uniques` = unique > 10)
```

```{r, eval=FALSE}
dredge(global.model = gam(tau.velocity.est ~
                            s(forest, k = 10) +
                            s(floodplain, k = 10) +
                            s(savannah, k = 10) +
                            s(dirt, k = 5) +
                            s(pasture, k = 5) +
                            s(crop, k = 5) +
                            s(water, k = 5),
                          family = Gamma('log'),
                          na.action = na.fail,
                          data = tapirs.lu.tv,
                          method = 'ML'),
       rank = 'AICc') %>%
  head(30)
```

```{r dredge-tau-v, size='small', echo=FALSE}
options(width = 110)
dredge(global.model = gam(tau.velocity.est ~
                            s(forest, k = 10) +
                            s(floodplain, k = 10) +
                            s(savannah, k = 10) +
                            s(dirt, k = 5) +
                            s(pasture, k = 5) +
                            s(crop, k = 5) +
                            s(water, k = 5),
                          family = Gamma('log'),
                          na.action = na.fail,
                          data = tapirs.lu.tv,
                          method = 'ML'),
       rank = 'AICc') %>%
  head(30)
options(width = 74)
```

Model 73 (`tau.velocity.est ~ s(forest, k = 10) + s(water, k = 5)`) is the best two-term model. While it is not substantially better than model 65 (`tau.velocity.est ~ s(water, k = 5)`), the `forest` smooth term was included because of the high range in proportion of forested habitat (0.138-1).

```{r}
m.tauv <- gam(tau.velocity.est ~ s(forest, k = 10) + s(water, k = 5),
              family = Gamma('log'),
              data = tapirs.lu,
              method = 'REML')
```

Create predictions for each model and plot them:

```{r}
# lu on hr (panel 5a)
pred.lu.hr <- tibble(dirt = seq(0, 0.22, length.out = 100))
pred.lu.hr <- bind_cols(pred.lu.hr,
                        predict(m.hr, newdata = pred.lu.hr, se.fit = TRUE)) %>%
  mutate(est = exp(fit),
         lwr = exp(fit - 1.96 * se.fit),
         upr = exp(fit + 1.96 * se.fit))

ggplot() +
  geom_ribbon(aes(dirt, ymin = lwr, ymax = upr), pred.lu.hr, alpha = 0.2) +
  geom_line(aes(dirt, est), pred.lu.hr) +
  geom_point(aes(dirt, area.est, color = region.lab), tapirs.lu, alpha = 0.9) +
  scale_color_manual('Region', values = pal[1:3], 
                     labels = c('Atlantic forest', 'Pantanal', 'Cerrado')) +
  labs(x = 'Proportion of exposed soil in the habitat',
       y = expression('Home Range Area'~(km^2))) +
  theme(legend.position = 'top',
        panel.grid = element_blank())

# forest on tau_v (5b)
newd.tv.f <- tibble(forest = seq_min_max(tapirs.lu$forest, n = 100),
                    water = mean(tapirs.lu$water, na.rm = TRUE))
pred.tv.f <-
  bind_cols(newd.tv.f, predict(m.tauv, newdata = newd.tv.f, se.fit = TRUE,
                               terms = 's(forest)')) %>%
  mutate(est = exp(fit),
         lwr = exp(fit - 1.96 * se.fit),
         upr = exp(fit + 1.96 * se.fit),
         model = 'Full dataset')

ggplot() +
  geom_ribbon(aes(forest, ymin = lwr, ymax = upr), pred.tv.f, alpha = 0.2) +
  geom_line(aes(forest, est), pred.tv.f) +
  geom_segment(aes(x = forest, xend = forest, y = tau.velocity.low,
                   yend = tau.velocity.high, color = region.lab), tapirs.lu,
               lwd = 0.5, alpha = 0.5) +
  geom_point(aes(forest, tau.velocity.est, color = region.lab,
                 shape = tau.velocity.est > 1.5),
             filter(tapirs.lu, ! is.na(tau.velocity.est)), alpha = 0.9) +
  scale_shape_manual('Outlier', values = c(19, 4), labels = c('No', 'Yes')) +
  scale_color_manual('Region', values = pal[1:3]) +
  labs(x = 'Proportion of forested habitat',
       y = 'Directional persistence (h)') +
  theme(legend.position = 'none')
```

### $\tau_v$ ~ s(forest) + s(water) without outlier

We can re-fit the best models for $\tau_v$ without the outlier:

```{r tauv-forest, fig.width=3.5, fig.height=3, fig.align='center'}
hist(tapirs.lu$tau.velocity.est, main = NULL, xlab = expression(widehat(tau[v])))
m.tauv.1 <- gam(tau.velocity.est ~ s(forest, k = 10) + s(water, k = 5),
                family = Gamma('log'),
                data = filter(tapirs.lu, tau.velocity.est < 1.5),
                method = 'REML')

# forest on tau_v (5b) without outlier
pred.tv.f <-
  bind_rows(pred.tv.f,
            bind_cols(newd.tv.f, predict(m.tauv.1, newdata = newd.tv.f, se.fit = TRUE,
                                         terms = 's(forest)')) %>%
              mutate(est = exp(fit),
                     lwr = exp(fit - 1.96 * se.fit),
                     upr = exp(fit + 1.96 * se.fit),
                     model = 'Without outlier'))
```

### $\tau_v$ ~ s(forest) + s(water) without outlier or Atlantic forest data

We can repeat the analysis for panels 5b without the data from the Atlantic forest biome (after having removed the outlier):

```{r}
m.tauv.2 <- gam(tau.velocity.est ~ s(forest, k = 10) + s(water, k = 5),
                family = Gamma('log'),
                data = filter(tapirs.lu,
                              tau.velocity.est < 1.5,
                              region != 'atlantica'),
                method = 'REML')

pred.tv.f <-
  bind_rows(pred.tv.f,
            bind_cols(newd.tv.f, predict(m.tauv.2, newdata = newd.tv.f, se.fit = TRUE,
                                         terms = 's(forest)')) %>%
              mutate(est = exp(fit),
                     lwr = exp(fit - 1.96 * se.fit),
                     upr = exp(fit + 1.96 * se.fit),
                     model = 'Without Atlantic forest or outlier'))

ggplot() +
  geom_ribbon(aes(forest, ymin = lwr, ymax = upr, fill = model), pred.tv.f, alpha=0.2) +
  geom_line(aes(forest, est, color = model), pred.tv.f) +
  geom_errorbar(aes(x = forest, ymin = tau.velocity.low, ymax = tau.velocity.high,
                    color = region.lab), alpha = 0.5, tapirs.lu)+
  geom_point(aes(forest, tau.velocity.est, color = region.lab,
                 shape = tau.velocity.est > 1.5),
             filter(tapirs.lu, ! is.na(tau.velocity.est))) +
  scale_color_manual(NULL, values = c(pal[1:3], 1, 2, 'blue'),
                     aesthetics = c('color', 'fill'),
                     breaks = c(levels(tapirs.lu$region.lab), unique(pred.tv.f$model))) +
  scale_shape_manual('Outlier', values = c(19, 4), labels = c('No', 'Yes')) +
  labs(x = 'Proportion of forested habitat',
       y = 'Directional persistence (h)') +
  theme(legend.position = 'top')
```

The removal of the outlier did not change the model's slope significantly, but it reduced model variance an appreciable amount. However, we do not have sufficient evidence to believe that the presence of the Atlantic forest data affected the model significantly, as its removal did not change the model slope substantially and the 95% confidence intervals of the two models (red and blue) mostly overlap.

\newpage

## Variation in movement across biomes and gradients of human disturbance (figure 6)

We can extract the ml-HFI for each tapir:

```{r joanna-akde-hfi, warning=FALSE, fig.cap='Autocorrelated Kernel Density Estimation for the home range of tapir labelled as "AF_01_JOANA". The solid line indicates the estimated 95% home range estimate, while the dashed lines indicate its 95% confidence inerval.'}
hfi.raster <- raster('../data/hfi-layers/ml_hfi_v1_2019.nc')

tapirs <-
  tapirs %>%
  mutate(region = factor(region), # need factors for GAMs
         hfi.mean = map_dbl(1:N, # add mean HFI
                            function(i)
                              extract(hfi.raster, as.sf(akde[[i]]))[[2]] %>% # take est
                              mean(na.rm = TRUE)),
         hr.size = map_dbl(akde, function(a) summary(a)$CI[2]))

# extract AKDE for the first tapir
joanna_akde <-
  SpatialPolygonsDataFrame.UD( # transform the AKDE to a spatial polygon
    object = tapirs$akde[[1]],
    proj4string = CRS(tapirs$data[[1]]@info$projection)) %>%
  spTransform(CRS("+proj=longlat")) %>% # change projection
  fortify() # change to data frame

# import ml-HFI raster
joanna_raster <- hfi.raster %>%
  crop(c(xmin = -52.37, xmax = -52.33,
         ymin = -22.55, ymax = -22.50)) %>%
  rasterToPoints() %>%
  data.frame() %>%
  fortify() %>%
  rename(hfi = X__xarray_dataarray_variable__)

# create a plot of the cropped ml-HFI raster and the AKDE
ggplot() +
  geom_raster(aes(x, y, fill = hfi), joanna_raster) + # ml-HFI raster
  geom_polygon(aes(x = long, y = lat, lwd = group, lty = group), # AKDE
               joanna_akde, color = 'white', fill = '#80808040', show.legend = FALSE) +
  scale_fill_viridis_c('ml-HFI', option = 'B', limits = c(0, 1)) +
  scale_x_continuous('Longitude', expand = c(0, 0)) +
  scale_y_continuous('Latitude', expand = c(0, 0)) +
  scale_size_manual(breaks = unique(joanna_akde$group), values = c(.5, 1.25, .5)) +
  scale_linetype_manual(breaks = unique(joanna_akde$group), values = c(2, 1, 2)) +
  theme(panel.border = element_rect(colour = 'black', fill = 'transparent'),
        legend.position = 'top')
```

We can then estimate the effect of ml-HFI on tapir movement.

```{r hfi-models, warning=FALSE}
# hfi on hr size
m.hr.0 <- gam(hr.size ~ hfi.mean, # hfi.mean is linear on the link (log) scale
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.hr.1 <- gam(hr.size ~ s(hfi.mean), # allow hfi.mean to be smooth
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.hr.2 <- gam(hr.size ~ region + s(hfi.mean), # different intercept per region
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.hr.3 <- gam(hr.size ~ s(hfi.mean, by = region), # different smooth per region
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.hr.4 <- gam(hr.size ~ region + s(hfi.mean, by = region),
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')

# accounting for effect of region does not improve the model fit
AIC(m.hr.0, m.hr.1, m.hr.2, m.hr.3, m.hr.4)
summary(m.hr.0)

# regression plot
pred.hr <- tibble(hfi.mean = seq(0.003, 0.31, length.out = 400))
pred.hr <- bind_cols(pred.hr,
                     predict(m.hr.0, newdata = pred.hr, se.fit = TRUE)) %>%
  mutate(est = exp(fit),
         lwr = exp(fit - 1.96 * se.fit),
         upr = exp(fit + 1.96 * se.fit))

ggplot() +
  geom_ribbon(aes(hfi.mean, ymin = lwr, ymax = upr), pred.hr, alpha = 0.2) +
  geom_line(aes(hfi.mean, est), pred.hr) +
  geom_segment(aes(x = hfi.mean, xend = hfi.mean, y = area.low,
                   yend = area.high, color = region.lab), tapirs, lwd = 0.5,
               alpha = 0.5) +
  geom_point(aes(hfi.mean, hr.size, color = region.lab), tapirs, alpha = 0.9) +
  scale_color_manual('Region', values = pal[1:3]) +
  labs(x = 'ml-HFI', y = expression('Home Range Area'~(km^2))) +
  theme(legend.position = 'top')

# hfi on average speed
m.sp.0 <- gam(speed.est ~ s(hfi.mean), # shrunk a linear term by REML (edf == 1)
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.sp.1 <- gam(speed.est ~ region + s(hfi.mean),
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.sp.2 <- gam(speed.est ~ s(hfi.mean, by = region),
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.sp.3 <- gam(speed.est ~ region + s(hfi.mean, by = region),
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')

# accounting for effect of region does not improve the model fit
AIC(m.sp.0, m.sp.1, m.sp.2, m.sp.3)
summary(m.sp.0)

# regression plot
pred.sp <-
  bind_cols(dplyr::select(pred.hr, hfi.mean),
            predict(m.sp.0, newdata = pred.hr, se.fit = TRUE)) %>%
  mutate(est = exp(fit),
         lwr = exp(fit - 1.96 * se.fit),
         upr = exp(fit + 1.96 * se.fit))

p3 <-
  ggplot(tapirs) +
  geom_ribbon(aes(hfi.mean, ymin = lwr, ymax = upr), pred.sp, alpha = 0.2) +
  geom_line(aes(hfi.mean, est), pred.sp) +
  geom_segment(aes(x = hfi.mean, xend = hfi.mean, y = speed.low,
                   yend = speed.high, color = region.lab), lwd = 0.5,
               alpha = 0.5) +
  geom_point(aes(hfi.mean, speed.est, color = region.lab), alpha = 0.9)+
  scale_color_manual('Region', values = pal[1:3]) +
  labs(x = 'ml-HFI', y = 'Average speed (km/day)') +
  theme(legend.position = 'top'); p3
```

We can re-fit the regression model without the Atlantic forest data to show the data point (0.039, 15.1) has little effect on the conclusion drawn from the model (i.e. no significant effect of ml-HFI on average speed). The model without the Atlantic forest data point is indicated in red:

```{r}
# without Mata Atlantica data
m.sp.0.a <- gam(speed.est ~ hfi.mean,
                family = Gamma('log'),
                data = filter(tapirs, region != 'atlantica'),
                method = 'REML')

pred.sp.a <-
  bind_cols(dplyr::select(pred.hr, hfi.mean),
            predict(m.sp.0.a, newdata = pred.hr, se.fit = TRUE)) %>%
  mutate(est = exp(fit),
         lwr = exp(fit - 1.96 * se.fit),
         upr = exp(fit + 1.96 * se.fit))

p3 +
  geom_ribbon(aes(hfi.mean, ymin = lwr, ymax = upr), pred.sp.a, alpha = 0.2,
              fill = 'red') +
  geom_line(aes(hfi.mean, est), pred.sp.a, color = 'red')
```

<!-- The following figures were not included in the submission: -->

```{r, include=FALSE, eval=FALSE}
# effect of ml-HFI on tau_v
m4 <- gam(tau.velocity.est ~ s(hfi.mean), # shrunk a linear term by REML
          family = Gamma('log'),
          data = tapirs,
          method = 'REML')
summary(m4)

# without outlier estimate
m4.1 <- gam(tau.velocity.est ~ s(hfi.mean),
            family = Gamma('log'),
            data = filter(tapirs, tau.velocity.est < 1.5),
            method = 'REML')
summary(m4.1)

pred4 <-
  bind_cols(dplyr::select(pred.hr, hfi.mean),
            predict(m4, newdata = pred.hr,
                    se.fit = TRUE)) %>%
  mutate(est = exp(fit),
         lwr = exp(fit - 1.96 * se.fit),
         upr = exp(fit + 1.96 * se.fit))
pred4.1 <-
  bind_cols(dplyr::select(pred.hr, hfi.mean),
            predict(m4.1, newdata = pred.hr,
                    se.fit = TRUE)) %>%
  mutate(est = exp(fit),
         lwr = exp(fit - 1.96 * se.fit),
         upr = exp(fit + 1.96 * se.fit))

ggplot(tapirs) +
  geom_ribbon(aes(hfi.mean, ymin = lwr, ymax = upr), pred4, alpha = 0.2) +
  geom_line(aes(hfi.mean, est), pred4) +
  geom_ribbon(aes(hfi.mean, ymin = lwr, ymax = upr), pred4.1, alpha = 0.2,
              fill = 'red') +
  geom_line(aes(hfi.mean, est), pred4.1, color = 'red') +
  geom_segment(aes(x = hfi.mean, xend = hfi.mean, y = tau.velocity.low,
                   yend = tau.velocity.high, color = region.lab), lwd = 0.5,
               alpha = 0.5) +
  geom_point(aes(hfi.mean, tau.velocity.est, color = region.lab), alpha = 0.9) +
  scale_color_manual('Region', values = pal[1:3]) +
  labs(x = 'ml-HFI', y = 'Directional persistence (hours)') +
  theme(legend.position = 'top')
```

\newpage

# Core home range analysis

This section repeats the analyses from section 2 and 3 based on core (50%) home range estimates. All analyses which are not based on home range estimates (e.g., those on $\tau_p, \tau_v$) are not repeated.

## Summary statistics for movement and space use parameters

```{r get-areas}
# function to extract core home range
get_core_area <- function(i) {
  summary(tapirs$akde[[i]], units = FALSE, level.UD = 0.5)$CI %>%
    as.data.frame() %>%
    as_tibble()
}
```

```{r create-tap-2, results = 'hide'}
tapirs <- readRDS('../models/tapirs-final.rds') %>% # tapir data
  bind_cols(map_dfr(1:N, get_core_area) %>%
              transmute(core.area.low = low / 1e6,
                        core.area.est = est / 1e6,
                        core.area.high = high / 1e6)) %>%
  mutate(
    # translate name
    region.lab = if_else(region.lab == 'Mata Atlantica', 'Atlantic forest', region.lab))

tap <-
  tapirs %>%
  bind_rows(
    bind_cols(name = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Overall'),
              region.lab = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Overall'),
              # core home range estimates
              bind_rows(
                meta(tapirs$model[tapirs$region=='atlantica'], plot=F, level.UD=0.5)[1,],
                meta(tapirs$model[tapirs$region=='pantanal'], plot=F, level.UD=0.5)[1,],
                meta(tapirs$model[tapirs$region=='cerrado'], plot=F, level.UD=0.5)[1,],
                meta(tapirs$model, plot = FALSE, level.UD = 0.5)[1, ]) %>%
                rename(core.area.low = low, core.area.est = est, core.area.high=high)))%>%
  mutate(name = factor(name, levels = c(unique(tapirs$name), 'Atlantic forest',
                                        'Pantanal', 'Cerrado', 'Overall')),
         region.lab = factor(region.lab,
                             levels = c('Atlantic forest', 'Pantanal', 'Cerrado',
                                        'Overall')),
         average = if_else(name %in% c('Atlantic forest','Pantanal','Cerrado','Overall'),
                           'Group mean', 'Individual') %>%
           factor(levels = c('Individual', 'Group mean'))) %>%
  select(region.lab, name, core.area.low:core.area.high, average)
```

```{r}
# est = estimated mean; low = lower 95% CI limit, high = upper 95% CI limit
tap %>%
  filter(average == 'Group mean') %>% # only group means
  select(-c(average, region.lab)) %>%
  relocate(name) %>% # move to be first column
  mutate(across(where(is.double), \(x) round(x, 2))) %>% # round to 2 decimals
  t() %>% # transpose to keep within page limits
  knitr::kable(caption = "Habitat-specific and overall means and 95% confidence intervals for the tapirs' core home range estimates.")
```

The overall mean core home range estimate was 1.92 km^2^ with CI (1.51, 2.41) km^2^ (see Table 2 above).

```{r}
range(tapirs$core.area.est) %>% round(digits = 1)
```

The range in core home range area estimates was 0.2 - 6.8 km^2^.

```{r}
# by sex
meta(list(female = filter(tapirs, sex == 'FEMALE')$akde,
          male = filter(tapirs, sex == 'MALE')$akde),
     plot = FALSE, verbose = TRUE, level.UD = 0.5) # verbose output with CIs

# by age group
meta(list(subadult = filter(tapirs, adult == 'No')$akde,
          adult = filter(tapirs, adult == 'Yes')$akde),
     plot = FALSE, verbose = TRUE, level.UD = 0.5)
```

Using `ctmm::meta()`, we found that core home range area was not significantly different ($\alpha = 0.05$) between sexes (females: mean = 1.28, 95% CI = (0.94, 1.71); males: mean = 1.14, 95% CI = (0.85, 1.51); LRT for female > male = 1.10, 95% CI = (0.70, 1.64)) nor between age groups (sub-adults: mean = 1.41, 95% CI = (0.79, 2.32); adults: mean = 1.15, 95% CI = (0.93, 1.41); LRT for sub-adult > adult = 1.21, 95% CI = (0.61, 2.04)).

\newpage

## Figures

### AKDE 95% home range estimates (figure 2)

```{r figure-2-2, fig.width = 6.46, height = 12, message=FALSE}
tapirs <- tapirs %>%
  mutate(proj = map(data, function(d) CRS(d@info$projection)),
         akde.df =
           map(1:N,
               function(i)
                 SpatialPolygonsDataFrame.UD(akde[[i]],
                                             proj4string = proj[[i]],
                                             level.UD = 0.5) %>%
                 spTransform(CRS("+proj=longlat")) %>%
                 fortify()))

atl.akdes <- bind_rows(tapirs$akde.df) %>% filter(grepl('AF_', group))
pan.akdes <- bind_rows(tapirs$akde.df) %>% filter(grepl('PA_', group))
cer.akdes <- bind_rows(tapirs$akde.df) %>% filter(grepl('CE_', group))

plot_grid(plot.akde('Atlantic Forest'), plot.akde('Pantanal'),
          plot.akde('Cerrado'), ncol = 2) # used ncol = 1 for figure in the main text
```

\newpage

### Parameter estimates using `ctmm::meta()` (figure 3)

```{r figure-3a-2}
# 3a) meta() of areas
ggplot(tap) +
  geom_segment(aes(x = core.area.low, xend = core.area.high, y = name, yend = name,
                   color = region.lab), lwd = 2) +
  geom_point(aes(x = core.area.est, y = name, shape = average), col = 'black', size=1.2) +
  geom_point(aes(x = core.area.est, y = name, shape = average), col = 'white', size=0.7) +
  scale_shape_manual(element_blank(), values = c(19, 17)) +
  scale_color_manual('Region', values = c(pal[1:3], 'black'),
                     labels = c('Atlantic forest', 'Pantanal', 'Cerrado', 'Overall')) +
  scale_y_discrete(limits = rev,
                   labels = c('Means', 'Cerrado', 'Pantanal', 'Atlantic forest'),
                   breaks = c('Atlantic forest', 'CE_15_KURUKA',
                              'PA_33_GABRIELA', 'AF_14_JAMESBOND')) +
  labs(x = bquote('Estimated core home range area'~(km^2)),
       y = NULL)
```

\newpage

### Strip charts (figure 4)

```{r figure-4-2, results='hide'}
tapirs <- tapirs %>%
  mutate(sex = if_else(sex == 'FEMALE', 'Female', 'Male'),
         adult = if_else(adult == 'Yes', 'Adult', 'Young'),
         name = factor(name,
                       levels = c(unique(name), 'Atlantic forest', 'Pantanal', 'Cerrado',
                                  'Overall')),
         sex_r = paste(sex, region.lab, sep = '_') %>%
           factor(levels = c('Female_Atlantic forest', 'Female_Pantanal',
                             'Female_Cerrado', 'Male_Atlantic forest',
                             'Male_Pantanal', 'Male_Cerrado')),
         adult_r = paste(adult, region.lab, sep = '_') %>%
           factor(levels = c('Adult_Atlantic forest', 'Adult_Pantanal',
                             'Adult_Cerrado', 'Young_Atlantic forest',
                             'Young_Pantanal', 'Young_Cerrado')))

# removed analyses on speed

## core home range, sex
summ_cs <-
  expand_grid(sex = unique(tapirs$sex),
              region.lab = unique(tapirs$region.lab)) %>%
  mutate(bind_cols(map2_dfr(region.lab, sex,
                            \(x, y) hr_estimates(REGION = x, SEX = y, level.ud = 0.5))))

## core home range, adult
summ_ca <-
  expand_grid(adult = unique(tapirs$adult),
              region.lab = unique(tapirs$region.lab)) %>%
  mutate(bind_cols(map2_dfr(region.lab, adult,
                            \(x, y) hr_estimates(REGION = x, ADULT = y, level.ud = 0.5))))

# summary plots ----
hr_s <- summary_plot(group = 'sex', Y = 'core.area.est')
hr_a <- summary_plot(group = 'adult', Y = 'core.area.est')
```

```{r}
plot_grid(get_legend(hr_s +
                       theme(legend.position = 'top')),
          plot_grid(hr_s, hr_a, ncol = 2, label_y = 1.08,
                    labels = c('c)', 'd)')),
          ncol = 1, rel_heights = c(0.1, 1))
```

\newpage

### Variation in movement across biomes and habitat composition (figure 5)

The best model is found using `MuMIn::dredge()`. Smooth terms are allowed to have a maximum `k` of 10 (or 5 if there are not enough unique values). The models are fit using maximum likelihood while using `MuMIn::dredge()`, but the best model is fit using Restricted Maximum Likelihood (REML).

<!-- print code but don't evaluate it -->
```{r}
tapirs.lu <- tapirs.lu %>%
  left_join(select(tapirs, name.short, core.area.est), by = 'name.short')
```

```{r, eval=FALSE}
# Gamma GAM regression on home range estimate
dredge(global.model = gam(core.area.est ~
                            s(forest, k = 10) +
                            s(floodplain, k = 10) +
                            s(savannah, k = 10) +
                            s(dirt, k = 10) +
                            s(pasture, k = 5) +
                            s(crop, k = 5) +
                            s(water, k = 5),
                          family = Gamma('log'),
                          data = tapirs.lu,
                          na.action = na.fail,
                          method = 'ML'), # need to use ML with dredge()
       rank = 'AICc') %>%
  head(20)
```

<!-- evaluate code but don't print it -->

```{r dredge-area-2, size='small', echo=FALSE}
options(width = 110)
# Gamma GAM regression on home range estimate
dredge(global.model = gam(core.area.est ~ # full model
                            s(forest, k = 10) +
                            s(floodplain, k = 10) +
                            s(savannah, k = 10) +
                            s(dirt, k = 10) +
                            s(pasture, k = 5) +
                            s(crop, k = 5) +
                            s(water, k = 5),
                          family = Gamma('log'),
                          data = tapirs.lu,
                          na.action = na.fail,
                          method = 'ML'), # need to use ML with dredge()
       rank = 'AICc') %>%
  head(20)
options(width = 74)
```

Model 9 with `s(forest)` as the only predictor is the best (parsimonious) model, since it is the best single-term model, and its AICc is not much larger than the model with the lowest AICc (`delta` = 1.28). Still, the effect of `s(forest)` is negligible.

```{r}
m.chr <- gam(core.area.est ~ s(forest, k = 10), # core home range
             family = Gamma('log'),
             data = tapirs.lu,
             method = 'REML')
summary(m.chr)
```

```{r}
# lu on hr (panel 5a)
pred.lu.hr <- tibble(forest = seq(0.13, 1, length.out = 300))
pred.lu.hr <- bind_cols(pred.lu.hr,
                        predict(m.chr, newdata = pred.lu.hr, se.fit = TRUE)) %>%
  mutate(est = exp(fit),
         lwr = exp(fit - 1.96 * se.fit),
         upr = exp(fit + 1.96 * se.fit))

ggplot() +
  geom_ribbon(aes(forest, ymin = lwr, ymax = upr), pred.lu.hr, alpha = 0.2) +
  geom_line(aes(forest, est), pred.lu.hr) +
  geom_point(aes(forest, core.area.est, color = region.lab), tapirs.lu, alpha = 0.9) +
  scale_color_manual('Region', values = pal[1:3], 
                     labels = c('Atlantic forest', 'Pantanal', 'Cerrado')) +
  labs(x = 'Proportion of exposed soil in the habitat',
       y = expression('Home Range Area'~(km^2))) +
  theme(legend.position = 'top',
        panel.grid = element_blank())
```

\newpage

### Variation in movement across biomes and gradients of human disturbance (figure 6)

We can extract the ml-HFI for each tapir:

```{r joanna-akde-hfi-2, warning=FALSE, fig.cap='Autocorrelated Kernel Density Estimation for the home range of tapir labelled as "AF_01_JOANA". The solid line indicates the estimated 95% home range estimate, while the dashed lines indicate its 95% confidence inerval.'}
tapirs <-
  tapirs %>%
  mutate(region = factor(region), # need factors for GAMs
         hfi.mean.core = map_dbl(1:N, # add mean HFI
                                 function(i)
                                   extract(hfi.raster,
                                           as.sf(akde[[i]], level.UD = 0.5))[[2]] %>%
                                   mean(na.rm = TRUE)),
         core.hr.size = map_dbl(akde, function(a) summary(a, level.UD = 0.5)$CI[2]))

# extract AKDE for the first tapir
joanna_akde <-
  SpatialPolygonsDataFrame.UD( # transform the AKDE to a spatial polygon
    object = tapirs$akde[[1]],
    proj4string = CRS(tapirs$data[[1]]@info$projection),
    level.UD = 0.5) %>% # core home range
  spTransform(CRS("+proj=longlat")) %>% # change projection
  fortify() # change to data frame

# import ml-HFI raster
joanna_raster <- hfi.raster %>%
  crop(c(xmin = -52.37, xmax = -52.33,
         ymin = -22.55, ymax = -22.50)) %>%
  rasterToPoints() %>%
  data.frame() %>%
  fortify() %>%
  rename(hfi = X__xarray_dataarray_variable__)

# create a plot of the cropped ml-HFI raster and the AKDE
ggplot() +
  geom_raster(aes(x, y, fill = hfi), joanna_raster) + # ml-HFI raster
  geom_polygon(aes(x = long, y = lat, lwd = group, lty = group), # AKDE
               joanna_akde, color = 'white', fill = '#80808040', show.legend = FALSE) +
  scale_fill_viridis_c('ml-HFI', option = 'B', limits = c(0, 1)) +
  scale_x_continuous('Longitude', expand = c(0, 0)) +
  scale_y_continuous('Latitude', expand = c(0, 0)) +
  scale_size_manual(breaks = unique(joanna_akde$group), # need 6 values because 2 areas
                    values = c(0.5, 0.5, 1.25, 1.25, 0.5, 0.5)) +
  scale_linetype_manual(breaks = unique(joanna_akde$group),
                        values = c(2, 2, 1, 1, 2, 2)) +
  theme(panel.border = element_rect(colour = 'black', fill = 'transparent'),
        legend.position = 'top')
```

We can then estimate the effect of ml-HFI on tapir movement.

```{r hfi-models-2, warning=FALSE}
# hfi on hr size
m.hr.0 <- gam(core.hr.size ~ hfi.mean.core, # hfi.mean is linear on the link (log) scale
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.hr.1 <- gam(core.hr.size ~ s(hfi.mean.core), # allow hfi.mean to be smooth
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.hr.2 <- gam(core.hr.size ~ region + s(hfi.mean.core), # different intercept per region
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.hr.3 <- gam(core.hr.size ~ s(hfi.mean.core, by = region), # different smooth per region
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')
m.hr.4 <- gam(core.hr.size ~ region + s(hfi.mean.core, by = region),
              family = Gamma('log'),
              data = tapirs,
              method = 'REML')

# accounting for effect of region does not improve the model fit
AIC(m.hr.0, m.hr.1, m.hr.2, m.hr.3, m.hr.4)
summary(m.hr.0)

# regression plot
pred.hr <- tibble(hfi.mean.core = seq(0.003, 0.31, length.out = 400))
pred.hr <- bind_cols(pred.hr,
                     predict(m.hr.0, newdata = pred.hr, se.fit = TRUE)) %>%
  mutate(est = exp(fit),
         lwr = exp(fit - 1.96 * se.fit),
         upr = exp(fit + 1.96 * se.fit))

ggplot() +
  geom_ribbon(aes(hfi.mean.core, ymin = lwr, ymax = upr), pred.hr, alpha = 0.2) +
  geom_line(aes(hfi.mean.core, est), pred.hr) +
  geom_errorbar(aes(x = hfi.mean.core, ymin = core.area.low, ymax = core.area.high,
                    color = region.lab), tapirs, lwd = 0.5, alpha = 0.5) +
  geom_point(aes(hfi.mean.core, core.hr.size, color = region.lab), tapirs, alpha = 0.9) +
  scale_color_manual('Region', values = pal[1:3]) +
  labs(x = 'ml-HFI', y = expression('Core Home Range Area'~(km^2))) +
  theme(legend.position = 'top')
```

\newpage

```{r}
sessionInfo()
```
